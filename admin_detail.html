<script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbzkOehJBDiiH7UwsMw1PpRCd__mZxVMQPrpswaEKKM6HLUe4AObXshAOCeQWDBrHJnEAQ/exec'; // <--- ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà URL ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

        let currentOrder = null;

        window.onload = function() {
            const dataStr = localStorage.getItem('viewOrderData');
            if (!dataStr) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                window.location.href = 'admin_orders.html';
                return;
            }
            currentOrder = JSON.parse(dataStr);
            renderPage(currentOrder);
        };

        function renderPage(order) {
            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß
            document.getElementById('qDate').innerText = order.date;
            document.getElementById('qName').innerText = order.name;
            let phone = order.phone.replace("'", "");
            document.getElementById('qPhone').innerText = phone;
            document.getElementById('qTotal').innerText = parseInt(order.total).toLocaleString();
            document.getElementById('qNote').innerText = order.note || '-';
            document.getElementById('btnCall').href = 'tel:' + phone;

            // --- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ---
            const itemsContainer = document.getElementById('qItems');
            let html = '';
            
            try {
                // 1. ‡∏•‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà)
                const items = JSON.parse(order.items);
                
                if (Array.isArray(items)) {
                    items.forEach((item, index) => {
                        let lineTotal = item.price * item.qty;
                        html += `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 10px;">
                                <strong>${index + 1}. ${item.name}</strong>
                            </td>
                            <td style="text-align: center; padding: 10px;">${item.qty}</td>
                            <td style="text-align: right; padding: 10px;">
                                <div>@${item.price.toLocaleString()}</div>
                                <div style="font-weight:bold;">${lineTotal.toLocaleString()}</div>
                            </td>
                        </tr>`;
                    });
                }

            } catch (e) {
                // 2. Fallback: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ (Text ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤) ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
                const lines = order.items.split('\n');
                lines.forEach(line => {
                    if (line.trim() !== '') {
                        html += `
                        <tr>
                            <td style="padding: 10px;">${line}</td>
                            <td style="text-align: center;">-</td>
                            <td style="text-align: right;">-</td>
                        </tr>`;
                    }
                });
            }

            itemsContainer.innerHTML = html;

            // Admin Panel
            document.getElementById('adminNote').value = order.admin_note || '';
            const status = order.status || '';
            if (status.includes('Contacted')) document.getElementById('chkContacted').checked = true;
            if (status.includes('Sent')) document.getElementById('chkSent').checked = true;
            if (status.includes('Closed')) document.getElementById('chkClosed').checked = true;
        }

        function saveUpdate() {
            if (!currentOrder) return;
            const btn = document.querySelector('.btn-save');
            btn.innerText = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            btn.disabled = true;

            let statusArr = [];
            if (document.getElementById('chkContacted').checked) statusArr.push('Contacted');
            if (document.getElementById('chkSent').checked) statusArr.push('Sent');
            if (document.getElementById('chkClosed').checked) statusArr.push('Closed');
            
            const newStatus = statusArr.length > 0 ? statusArr.join(', ') : 'Pending';
            const newNote = document.getElementById('adminNote').value;

            fetch(scriptURL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'update_order',
                    rowIndex: currentOrder.rowIndex,
                    status: newStatus,
                    admin_note: newNote
                })
            })
            .then(response => response.json())
            .then(res => {
                if (res.status === 'success') {
                    alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                    currentOrder.status = newStatus;
                    currentOrder.admin_note = newNote;
                    localStorage.setItem('viewOrderData', JSON.stringify(currentOrder));
                } else {
                    alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                }
                btn.innerText = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ & ‡πÇ‡∏ô‡πâ‡∏ï';
                btn.disabled = false;
            })
            .catch(err => {
                alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
                btn.innerText = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ & ‡πÇ‡∏ô‡πâ‡∏ï';
                btn.disabled = false;
            });
        }
    </script>
