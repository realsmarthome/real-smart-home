<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --bg-dark: #121212; --panel-dark: #1e1e1e; --accent: #00d2ff; --text: #fff; }
        body { font-family: 'Prompt', sans-serif; background: var(--bg-dark); color: var(--text); margin: 0; padding: 20px; }

        .container { max-width: 1200px; margin: 0 auto; display: flex; gap: 30px; }
        
        /* ‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢: ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©) */
        .quotation-wrapper { flex: 2; }
        .paper {
            background: #fff; color: #333; padding: 40px; border-radius: 5px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5); min-height: 800px; position: relative;
        }
        .paper-header { display: flex; justify-content: space-between; border-bottom: 2px solid #ddd; padding-bottom: 20px; margin-bottom: 20px; }
        .logo { font-size: 1.5rem; font-weight: bold; color: #000; text-transform: uppercase; }
        .meta-info { text-align: right; font-size: 0.9rem; color: #555; }
        .customer-info { margin-bottom: 30px; padding: 15px; background: #f9f9f9; border-radius: 5px; }
        .q-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        .q-table th { background: #333; color: #fff; padding: 10px; text-align: left; }
        .q-table td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: top; }
        .total-section { text-align: right; font-size: 1.2rem; font-weight: bold; margin-top: 20px; }
        .total-price { color: #d32f2f; font-size: 1.8rem; }
        .cust-note { font-size: 0.9rem; color: #666; margin-top: 30px; border-top: 1px dashed #ccc; padding-top: 10px; }

        /* ‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤: ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô */
        .admin-panel { flex: 1; display: flex; flex-direction: column; gap: 20px; }
        .card { background: var(--panel-dark); padding: 20px; border-radius: 10px; border: 1px solid #333; }
        .card h3 { color: var(--accent); margin-top: 0; font-size: 1.1rem; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        .status-options label { display: block; margin-bottom: 10px; cursor: pointer; }
        .admin-note-area { width: 100%; background: #2a2a2a; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 5px; font-family: 'Prompt'; resize: vertical; margin-bottom: 10px;}
        
        .btn { display: block; width: 100%; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-family: 'Prompt'; margin-bottom: 10px; transition: 0.2s; text-align: center; text-decoration: none; }
        .btn-save { background: var(--accent); color: #000; }
        .btn-save:hover { background: #fff; }
        .btn-print { background: #444; color: #fff; }
        .btn-tel { background: #00c853; color: #fff; }
        .btn-back { background: transparent; color: #aaa; border: 1px solid #555; }

        /* ‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå */
        @media print {
            body { background: #fff; padding: 0; }
            .admin-panel, .btn-back { display: none !important; }
            .container { display: block; }
            .quotation-wrapper { width: 100%; }
            .paper { box-shadow: none; padding: 0; }
        }

        @media (max-width: 900px) { .container { flex-direction: column-reverse; } }
    </style>
</head>
<body>

    <div class="container">
        <div class="quotation-wrapper">
            <div class="paper">
                <div class="paper-header">
                    <div class="logo">Real Smart Home</div>
                    <div class="meta-info">
                        <strong>‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ / Quotation</strong><br>
                        ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="qDate">-</span>
                    </div>
                </div>

                <div class="customer-info">
                    <strong>‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:</strong> <span id="qName">-</span><br>
                    <strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</strong> <span id="qPhone">-</span>
                </div>

                <table class="q-table">
                    <thead>
                        <tr>
                            <th style="width: 50%;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Description)</th>
                            <th style="text-align: center; width: 15%;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                            <th style="text-align: right; width: 35%;">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢ | ‡∏£‡∏ß‡∏°</th>
                        </tr>
                    </thead>
                    <tbody id="qItems">
                        </tbody>
                </table>

                <div class="total-section">
                    ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: <span class="total-price" id="qTotal">0</span> ‡∏ö‡∏≤‡∏ó
                </div>

                <div class="cust-note">
                    <strong>üìù ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong><br>
                    <span id="qNote">-</span>
                </div>

                <div style="margin-top: 50px; font-size: 0.8rem; color: #999; text-align: center;">
                    *‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏á<br>
                    Real Smart Home | ‡πÇ‡∏ó‡∏£: 083 0909 036 | Line: @realsmarthome
                </div>
            </div>
        </div>

        <div class="admin-panel">
            <a href="admin_orders.html" class="btn btn-back">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</a>

            <div class="card">
                <h3><i class="fa-solid fa-list-check"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô (Status)</h3>
                <div class="status-options">
                    <label>
                        <input type="checkbox" id="chkContacted"> ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß
                    </label>
                    <label>
                        <input type="checkbox" id="chkSent"> ‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡πâ‡∏ß
                    </label>
                    <label>
                        <input type="checkbox" id="chkClosed"> <strong>‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</strong>
                    </label>
                </div>
            </div>

            <div class="card">
                <h3><i class="fa-solid fa-note-sticky"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥ (Admin Note)</h3>
                <textarea id="adminNote" rows="5" class="admin-note-area" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ô‡∏±‡∏î‡∏î‡∏π‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå..."></textarea>
                <button class="btn btn-save" onclick="saveUpdate()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ & ‡πÇ‡∏ô‡πâ‡∏ï</button>
            </div>

            <div class="card">
                <h3><i class="fa-solid fa-bolt"></i> Action ‡∏î‡πà‡∏ß‡∏ô</h3>
                <a href="#" id="btnCall" class="btn btn-tel"><i class="fa-solid fa-phone"></i> ‡πÇ‡∏ó‡∏£‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</a>
                <button class="btn btn-print" onclick="window.print()"><i class="fa-solid fa-print"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå / PDF</button>
            </div>
        </div>
    </div>

    <script>
        // **********************************************
        // ‡πÉ‡∏™‡πà URL Google Apps Script ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        // **********************************************
        const scriptURL = 'https://script.google.com/macros/s/AKfycbzkOehJBDiiH7UwsMw1PpRCd__mZxVMQPrpswaEKKM6HLUe4AObXshAOCeQWDBrHJnEAQ/exec';

        let currentOrder = null;

        window.onload = function() {
            const dataStr = localStorage.getItem('viewOrderData');
            
            if (!dataStr) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà');
                window.location.href = 'admin_orders.html';
                return;
            }

            currentOrder = JSON.parse(dataStr);
            renderPage(currentOrder);
        };

        function renderPage(order) {
            // 1. ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
            document.getElementById('qDate').innerText = order.date;
            document.getElementById('qName').innerText = order.name;
            let phone = order.phone.replace("'", "");
            document.getElementById('qPhone').innerText = phone;
            document.getElementById('qTotal').innerText = parseInt(order.total).toLocaleString();
            document.getElementById('qNote').innerText = order.note || '-';
            document.getElementById('btnCall').href = 'tel:' + phone;

            // 2. ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤)
            const itemsContainer = document.getElementById('qItems');
            let html = '';
            
            try {
                // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÅ‡∏õ‡∏•‡∏á Text ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô JSON Array
                let items = [];
                if (typeof order.items === 'string') {
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ [)
                    if (order.items.trim().startsWith('[')) {
                        items = JSON.parse(order.items);
                    } else {
                        throw new Error("Old text format"); // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON ‡πÉ‡∏´‡πâ‡πÇ‡∏¢‡∏ô‡πÑ‡∏õ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤
                    }
                } else {
                    items = order.items; // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô Object ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
                }

                // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                if (Array.isArray(items)) {
                    items.forEach(item => {
                        let lineTotal = item.price * item.qty;
                        html += `
                        <tr>
                            <td>
                                <strong>${item.name}</strong>
                            </td>
                            <td style="text-align:center; font-size: 1.1rem;">${item.qty}</td> 
                            <td style="text-align:right;">
                                <div style="font-size: 0.85rem; color: #666;">@${item.price.toLocaleString()}</div>
                                <div style="font-weight:bold; color: #000;">${lineTotal.toLocaleString()}</div>
                            </td>
                        </tr>`;
                    });
                }

            } catch (e) {
                // Fallback: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ (‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Å‡πâ‡∏£‡∏∞‡∏ö‡∏ö) ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
                // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏û‡∏±‡∏á
                const lines = order.items.split('\n');
                lines.forEach(line => {
                    if(line.trim() !== '') {
                        html += `<tr>
                            <td>${line}</td>
                            <td style="text-align:center;">-</td> 
                            <td style="text-align:right;">-</td>
                        </tr>`;
                    }
                });
            }
            itemsContainer.innerHTML = html;

            // 3. ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Admin Panel
            document.getElementById('adminNote').value = order.admin_note || '';
            
            const status = order.status || '';
            if (status.includes('Contacted')) document.getElementById('chkContacted').checked = true;
            if (status.includes('Sent')) document.getElementById('chkSent').checked = true;
            if (status.includes('Closed')) document.getElementById('chkClosed').checked = true;
        }

        function saveUpdate() {
            if (!currentOrder) return;

            const btn = document.querySelector('.btn-save');
            btn.innerText = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            btn.disabled = true;

            let statusArr = [];
            if (document.getElementById('chkContacted').checked) statusArr.push('Contacted');
            if (document.getElementById('chkSent').checked) statusArr.push('Sent');
            if (document.getElementById('chkClosed').checked) statusArr.push('Closed');
            
            const newStatus = statusArr.length > 0 ? statusArr.join(', ') : 'Pending';
            const newNote = document.getElementById('adminNote').value;

            fetch(scriptURL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'update_order',
                    rowIndex: currentOrder.rowIndex,
                    status: newStatus,
                    admin_note: newNote
                })
            })
            .then(response => response.json())
            .then(res => {
                if (res.status === 'success') {
                    alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                    currentOrder.status = newStatus;
                    currentOrder.admin_note = newNote;
                    localStorage.setItem('viewOrderData', JSON.stringify(currentOrder));
                } else {
                    alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + res.message);
                }
                btn.innerText = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ & ‡πÇ‡∏ô‡πâ‡∏ï';
                btn.disabled = false;
            })
            .catch(err => {
                console.error(err);
                alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
                btn.innerText = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ & ‡πÇ‡∏ô‡πâ‡∏ï';
                btn.disabled = false;
            });
        }
    </script>
</body>
</html>
